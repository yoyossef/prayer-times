#!/bin/bash

# ----- Parameters ------ #
# Mawaqit masjid id: https://mawaqit.com
mawaqit_masjid_id=''
# Coordinates: https://www.mapcoordinates.net/en
lat='30.001780'
long='31.290419'
# Calculation Method: https://api.aladhan.com/v1/methods
method='5'
# Print Text Language (en/ar)
print_lang='ar'
# Notifcation Daemon
notify='dunst'
# ----------------------- #
prayers_json="$HOME/.local/share/prayers.json"
prayers=("Fajr" "Dhuhr" "Asr" "Maghrib" "Isha")
declare -A date
declare -A epochtimes
declare -A prayers_ar
prayers_ar=(
  ["Fajr"]="Ø§Ù„ÙØ¬Ø±"
  ["Sunrise"]="Ø§Ù„Ø´Ø±ÙˆÙ‚"
  ["Dhuhr"]="Ø§Ù„Ø¸Ù‡Ø±"
  ["Asr"]="Ø§Ù„Ø¹ØµØ±"
  ["Maghrib"]="Ø§Ù„Ù…ØºØ±Ø¨"
  ["Isha"]="Ø§Ù„Ø¹Ø´Ø§Ø¡"
)
date=(
  [day]=$(date +%-d)
  [day_idx]=$(($(date +%-d) - 1))
  [weekday]=$(date +%a)
  [month]=$(date +%-m)
  [month_idx]=$(($(date +%-m) - 1))
  [year]=$(date +%Y)
)

nameof() {
  if [[ "$print_lang" != "en" ]]; then
    local array_name="prayers_$print_lang"
    eval "echo -n \${${array_name}[$1]}"
  else
    echo -n "$1"
  fi
}

# Helper function to fetch prayer times from Mawaqit
fetch_mawaqit_prayers() {
  local masjid_id="$1"
  local url="https://mawaqit.net/fr/${masjid_id}"

  echo "-- Fetching prayer times from Mawaqit for mosque ID: $masjid_id"

  local page_content
  page_content=$(curl -s "$url")

  if [[ -z "$page_content" ]]; then
    echo "Error: Unable to fetch data for mosque ID $masjid_id"
    return 1
  fi

  local conf_data
  conf_data=$(echo "$page_content" | grep -oP 'var confData = \K.*?(?=;)' | sed 's/;$//')

  if [[ -z "$conf_data" ]]; then
    echo "Error: Unable to find prayer times data in the response."
    return 1
  fi

  echo "$conf_data" > "$prayers_json"
}

add_calendar_info_to_json() {
  # Save the current Gregorian date info in the JSON
  jq --arg year "${date[year]}" --arg month "${date[month]}" \
    '. + {localAppYear: $year, localAppMonth: $month}' \
    "$prayers_json" > tmp.json && mv tmp.json "$prayers_json"

  # Fetch the Hijri calendar data from the Aladhan API
  # Documentation: https://aladhan.com/islamic-calendar-api#GetGToHCalendar
  local api_url="http://api.aladhan.com/v1/gToHCalendar/${date[month]}/${date[year]}"
  local response=$(curl -s "$api_url")

  if [[ -z "$response" || "$(echo "$response" | jq -r '.code')" != "200" ]]; then
    echo "Error: Failed to fetch Hijri calendar data from Aladhan API"
    return 1
  fi

  local local_app_calendar=$(echo "$response" | jq '.data')
  jq --argjson localAppCalendar "$local_app_calendar" \
    '. + {localAppCalendar: $localAppCalendar}' "$prayers_json" > tmp.json && \
    mv tmp.json "$prayers_json"
}

check() {
  if [[ -r $prayers_json ]]; then
    local available_year=$(jq -r ".year" "$prayers_json")
    local available_month=$(jq -r ".month" "$prayers_json")
  else
    local fetch_prayers=1
  fi

  if [[ -n "$mawaqit_masjid_id" && ("$fetch_prayers" || "$available_year" != "${date[year]}") ]]; then
    echo "-- Fetching current year prayer calendar (${date[year]})"
    fetch_mawaqit_prayers "$mawaqit_masjid_id"
    add_calendar_info_to_json
  else
    if [[ "$fetch_prayers" || "$available_month" != "${date[month]}" ]]; then
      echo "-- Fetching current month prayer calendar (${date[month]}-${date[year]})"
      # Documentation: https://aladhan.com/prayer-times-api#GetCalendar
      curl -Lso "$prayers_json" "https://api.aladhan.com/v1/calendar/${date[year]}/${date[month]}?latitude=$lat&longitude=$long&method=$method"
    fi
  fi
  # Update calendar info for both Aladhan and Mawaqit consumers if month has expired
  if [[ "$available_month" != "${date[month]}" ]]; then
      add_calendar_info_to_json
  fi
}

add-jobs() {
  # WARNING: THIS SCRIPTS REMOVES ALL JOBS IN QUEUE "P" SCHEDULED USING AT (ADJUST ACCORDINGLY)
  echo "-- removing all jobs in queue 'p'"
  if [[ "$(at -q p -l | wc -l)" != "0" ]]; then
    for i in $(at -q p -l | awk '{ print $1 }'); do
      atrm "$i"
    done
  fi

  for prayer in "${prayers[@]}"; do
    echo "-- creating at job for $prayer prayer"
    if [[ "$notify" == "mako" ]]; then
      printf 'notify-send -t 30000 --icon="clock-applet-symbolic" "Prayer Times" "It is time for %s prayer ðŸ•Œ"' "$prayer" | at -q p "$(timeof "$prayer" '%H:%M %F')"
    else
      printf '[ "$(dunstify --icon="clock-applet-symbolic" --action="Reply,reply" "Prayer Times" "Time for %s prayer ðŸ•Œ" -t 30000)" = "2" ] && %s' "$prayer" "$HOME/.local/bin/toggle-athan" | at -q p "$(timeof "$prayer" '%H:%M %F')"
    fi
  done
}

timeof() {
  [[ "$#" -lt "1" ]] && echo "at least 1 argument is needed" && return 1

  if [[ -n "$mawaqit_masjid_id" ]]; then
    # For Mawaqit data
    local timing_key="$1"
    local prayer_time

    case "$timing_key" in
      Fajr) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[0]" "$prayers_json") ;;
      Sunrise) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[1]" "$prayers_json") ;;
      Dhuhr) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[2]" "$prayers_json") ;;
      Asr) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[3]" "$prayers_json") ;;
      Maghrib) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[4]" "$prayers_json") ;;
      Isha) prayer_time=$(jq -r ".calendar[${date[month_idx]}].\"${date[day]}\"[5]" "$prayers_json") ;;
      *) echo "Invalid prayer time requested: $timing_key" && return 1 ;;
    esac

    # Convert to seconds if requested
    if [[ "$2" == "%s" ]]; then
      echo -n "$(date -d "$(date +%Y-%m-%d) $prayer_time" +%s)"
    else
      echo "$prayer_time"
    fi

  else
    # For Aladhan API data
    echo -n "$(date -d "$(jq -r ".data[${date[day_idx]}].timings.$1" "$prayers_json")" "+${2:-%I:%M}")"
  fi
}

hijri() {
  case "$1" in
  weekday)
    if [[ "$print_lang" == "ar" ]]; then
      echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.weekday.ar" "$prayers_json")"
    else
      echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.weekday.en" "$prayers_json")"
    fi
    ;;
  day)
    echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.day" "$prayers_json")"
    ;;
  month)
    if [[ "$print_lang" == "ar" ]]; then
      echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.month.ar" "$prayers_json")"
    else
      echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.month.en" "$prayers_json")"
    fi
    ;;
  year)
    echo -n "$(jq -r ".localAppCalendar[${date[day_idx]}].hijri.year" "$prayers_json")"
    ;;
  *)
    echo "unsupported argument: $1" && return 1
    ;;
  esac
}

settimes() {
  # return if array already populated
  [[ "${#epochtimes[@]}" -gt 0 ]] && return 0

  epochtimes=(
    [now]=$(date +%s)
    [fajr]=$(timeof Fajr %s)
    [dhuhr]=$(timeof Dhuhr %s)
    [asr]=$(timeof Asr %s)
    [maghrib]=$(timeof Maghrib %s)
    [isha]=$(timeof Isha %s)
  )

  local nxt_idx=0
  local curr_idx=4
  for i in {4..0}; do
    local prayer_key="${prayers[$i],,}"
    if [[ "${epochtimes[now]}" -ge "${epochtimes[$prayer_key]}" ]]; then
      [[ "$i" -lt "4" ]] && curr_idx=$i && nxt_idx=$((i + 1))
      break
    fi
  done

  local next_key="${prayers[$nxt_idx],,}"
  epochtimes[next]="${epochtimes[$next_key]}"
  currentprayer="${prayers[$curr_idx]}"
  nextprayer="${prayers[$nxt_idx]}"
  if [[ "$nxt_idx" == "1" && "${date[weekday]}" == "Fri" ]]; then
    nextprayer="Jumuaa"
  fi
}

timeto() {
  [[ "$#" -lt "1" ]] && echo "atleast 1 argument are needed" && return 1
  settimes
  remain="$((epochtimes["${1,,}"] - epochtimes[now]))"
  [[ "$remain" -lt "0" ]] && remain="$((remain + 86400))"
  date -u -d"@$remain" "+${2:-%H:%M}"
}

print() {
  local format="ðŸ“… %sØŒ%s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n%-12s%-10s\n"
  if [[ "$print_lang" == "ar" ]]; then
    format="ðŸ“… %sØŒ%s\n%s%11s\n%s%10s\n%s%11s\n%s%11s\n%s%10s\n%s%10s\n"
  fi

  printf "$format" \
    "$(hijri weekday)" \
    "$(hijri day)-$(hijri month)-$(hijri year)" \
    "Ûž $(nameof Fajr)" "$(timeof Fajr)" \
    "Ûž $(nameof Sunrise)" "$(timeof Sunrise)" \
    "Ûž $(nameof Dhuhr)" "$(timeof Dhuhr)" \
    "Ûž $(nameof Asr)" "$(timeof Asr)" \
    "Ûž $(nameof Maghrib)" "$(timeof Maghrib)" \
    "Ûž $(nameof Isha)" "$(timeof Isha)"
}

yad-en() {
  yad \
    --text-width=10 \
    --on-top \
    --text \
    "<span font-size='large'><b>ðŸ“… $(hijri weekday),$(hijri day)-$(hijri month)-$(hijri year)</b></span>" \
    --list \
    --width=300 \
    --height=250 \
    --title="Prayers" \
    --column="Prayer" \
    --column="Time" \
    --expand-column=1 \
    --no-buttons \
    --no-click \
    --no-selection \
    "<span font-size='large'>$(nameof Fajr)</span>" "<span font-size='large'>$(timeof Fajr)</span>" \
    "<span font-size='large'>$(nameof Sunrise)</span>" "<span font-size='large'>$(timeof Sunrise)</span>" \
    "<span font-size='large'>$(nameof Dhuhr)</span>" "<span font-size='large'>$(timeof Dhuhr)</span>" \
    "<span font-size='large'>$(nameof Asr)</span>" "<span font-size='large'>$(timeof Asr)</span>" \
    "<span font-size='large'>$(nameof Maghrib)</span>" "<span font-size='large'>$(timeof Maghrib)</span>" \
    "<span font-size='large'>$(nameof Isha)</span>" "<span font-size='large'>$(timeof Isha)</span>"
}

yad-ar() {
  yad \
    --text-width=10 \
    --on-top \
    --text-align='right' \
    --text \
    "<span font-size='large'><b>ðŸ“… $(hijri weekday),$(hijri day)-$(hijri month)-$(hijri year)</b></span>" \
    --list \
    --width=250 \
    --height=240 \
    --title="Prayers" \
    --column="Ø§Ù„ÙˆÙ‚Øª" \
    --column="Ø§Ù„ØµÙ„Ø§Ø©" \
    --expand-column=1 \
    --no-buttons \
    --no-click \
    --no-selection \
    "<span font-size='large'>$(timeof Fajr)</span>" "<span font-size='large'>$(nameof Fajr)</span>" \
    "<span font-size='large'>$(timeof Sunrise)</span>" "<span font-size='large'>$(nameof Sunrise)</span>" \
    "<span font-size='large'>$(timeof Dhuhr)</span>" "<span font-size='large'>$(nameof Dhuhr)</span>" \
    "<span font-size='large'>$(timeof Asr)</span>" "<span font-size='large'>$(nameof Asr)</span>" \
    "<span font-size='large'>$(timeof Maghrib)</span>" "<span font-size='large'>$(nameof Maghrib)</span>" \
    "<span font-size='large'>$(timeof Isha)</span>" "<span font-size='large'>$(nameof Isha)</span>"
}

yad-toggle() {
  local yad_pid
  yad_pid=$(pgrep -f 'yad.*Prayers')

  if [[ -z "$yad_pid" ]]; then
    if [[ "$print_lang" == "ar" ]]; then
      yad-ar
    else
      yad-en
    fi

  else
    kill "$yad_pid"
  fi
}

current() {
  settimes
  echo "$currentprayer"
}

next() {
  settimes
  echo "$nextprayer"
}

remaining() {
  settimes
  timeto next "%H:%M:%S"
}

status() {
  settimes
  local remain
  remain="$(timeto next)"
  echo "$nextprayer in $remain"
}

waybar-status() {
  settimes
  local remain
  remain="$(timeto next)"
  local next_text="$nextprayer in $remain"
  printf '{ "text": "%s", "class": "%s" }' "$next_text" "$nextprayer"
}

case "$1" in
check)
  check
  ;;
jobs)
  add-jobs
  ;;
sync)
  check
  add-jobs
  ;;
print)
  print
  ;;
current)
  current
  ;;
next)
  next
  ;;
remaining)
  remaining
  ;;
status)
  status
  ;;
yad)
  yad-toggle
  ;;
waybar)
  waybar-status
  ;;
timeto)
  if [[ -n "$2" ]]; then
    if [[ "$2" == "next" ]]; then
      valid=1
    else
      for p in "${prayers[@]}"; do
        if [[ "${2^}" == "$p" ]]; then
          valid=1
          break
        fi
      done
    fi
  fi

  if [[ -z "$valid" ]]; then
    IFS='|'
    echo "Usage: $(basename "$0") timeto (next|${prayers[*],,})"
    exit 1
  fi

  timeto "$2"
  ;;
*)
  echo "Usage: $(basename "$0") [command]"
  echo "Command:"
  echo "  check      Check if prayer time data needs to be fetched"
  echo "  jobs       Add prayer time notifications as at jobs"
  echo "  sync       Check and sync prayer time data, and add notifications"
  echo "  print      Print prayer times"
  echo "  current    Get the current prayer"
  echo "  next       Get the next prayer"
  echo "  remaining  Get the remaining time for the next prayer"
  echo "  status     Get the status message indicating the next prayer"
  echo "  timeto     Get the time remaining for a prayer"
  echo "  yad        Toggle the yad window showing prayer times"
  echo "  waybar     Print waybar JSON-formatted status"
  exit 1
  ;;
esac
